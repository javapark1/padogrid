package ${KRYO_SERIALIZER_PACKAGE};

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.esotericsoftware.kryo.Kryo;
import com.esotericsoftware.kryo.io.Input;
import com.esotericsoftware.kryo.io.Output;
import com.hazelcast.nio.ObjectDataInput;
import com.hazelcast.nio.ObjectDataOutput;
import com.hazelcast.nio.serialization.StreamSerializer;

/**
 * This class is generated by the PadoGrid Code Generator. You can modify this
 * class as needed. It will not be overwritten when you generate it again later.
 * 
 * @since ${DATE}
 * @author ${AUTHOR}
 * @see <a href="https://github.com/padogrid/padogrid">https://github.com/padogrid/padogrid</a>
 */
public class KryoSerializer implements StreamSerializer<Object> {

	private static final ThreadLocal<Kryo> kryoThreadLocal = new ThreadLocal<Kryo>() {

		@Override
		protected Kryo initialValue() {
			Kryo kryo = new Kryo();
			return kryo;
		}
	};
	
	private static Class<?>[] classes = new Class<?>[] {
		${CLASSES}
	};
	
	private static Map<Class<?>, Integer> classMap = new HashMap<Class<?>, Integer>(classes.length, 1f);
	
	static {
		int i = 0;
		for (Class<?> clazz : classes) {
			classMap.put(clazz, i++);
		}
	}
	
	public static List<Class<?>> getClassList()
	{
		return Collections.unmodifiableList(Arrays.asList(classes));
	}
	
	public static Integer getClassId(Class<?> clazz) {
		return classMap.get(clazz);
	}
	
	public static int getLastClassId()
	{
		return classes.length - 1;
	}
	
	@Override
	public int getTypeId() {
		return 1100;
	}

	@Override
	public void destroy() {
		kryoThreadLocal.remove();
	}
	
	private int getWriteTypeId(Object obj)
	{
		if (obj == null) {
			return 0xFF;
		}
		Class<?> clazz = obj.getClass();
		return classMap.get(clazz);
	}
	
	private Object readKryo(Input input, Kryo kryo, int typeId)
	{
		if (typeId < 0 || typeId >= classes.length) {
			return null;
		}
		kryo.register(classes[typeId]);
		return kryo.readObject(input, classes[typeId]);
	}

	@Override
	public void write(ObjectDataOutput odout, Object obj) throws IOException {
		 Kryo kryo = kryoThreadLocal.get();
		 odout.writeByte(getWriteTypeId(obj));
		 kryo.register(obj.getClass());
         Output output = new Output((OutputStream) odout);
         kryo.writeObject(output, obj);
         output.flush();
	}

	@Override
	public Object read(ObjectDataInput odin) throws IOException {
		byte typeId = odin.readByte();
		InputStream in = (InputStream) odin;
        Input input = new Input(in);
        Kryo kryo = kryoThreadLocal.get();
        return readKryo(input, kryo, typeId);
	}
}

